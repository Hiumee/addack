package database

import (
	"github.com/hiumee/addack/src/model"
)

func (db *Database) CreateExploitsTable() error {
	_, err := db.DB.Exec("CREATE TABLE IF NOT EXISTS exploits (id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL, name TEXT, command TEXT, path TEXT, tag TEXT, timeout INTEGER, enabled BOOLEAN DEFAULT 1)")
	return err
}

func (db *Database) CreateExploit(exploit model.Exploit) (int64, error) {
	res, err := db.DB.Exec("INSERT INTO exploits (name, command, path, tag, timeout, enabled) VALUES ($1, $2, $3, $4, $5, $6)", exploit.Name, exploit.Command, exploit.Path, exploit.Tag, exploit.Timeout, exploit.Enabled)

	if err != nil {
		return 0, err
	}

	id, err := res.LastInsertId()

	return id, nil
}

func (db *Database) GetExploit(id int64) (model.Exploit, error) {
	var exploit model.Exploit
	err := db.DB.QueryRow("SELECT * FROM exploits WHERE id = $1", id).Scan(&exploit.Id, &exploit.Name, &exploit.Command, &exploit.Path, &exploit.Tag, &exploit.Timeout, &exploit.Enabled)
	return exploit, err
}

func (db *Database) GetExploits() ([]model.Exploit, error) {
	var exploits []model.Exploit
	rows, err := db.DB.Query("SELECT exploits.id, exploits.name, exploits.command, exploits.path, exploits.tag, exploits.timeout, exploits.enabled, (select count(*) from flags where flags.exploit_id = exploits.id and flags.valid = 'valid'), (select count(*) from flags where flags.exploit_id = exploits.id and flags.valid = 'valid' and flags.timestamp > datetime('now', '-5 minutes')) FROM exploits")
	if err != nil {
		return exploits, err
	}
	defer rows.Close()
	for rows.Next() {
		var exploit model.Exploit
		err := rows.Scan(&exploit.Id, &exploit.Name, &exploit.Command, &exploit.Path, &exploit.Tag, &exploit.Timeout, &exploit.Enabled, &exploit.Flags, &exploit.FlagsLast5Minutes)
		if err != nil {
			return exploits, err
		}
		exploits = append(exploits, exploit)
	}
	return exploits, err
}

func (db *Database) UpdateExploit(exploit model.Exploit) error {
	_, err := db.DB.Exec("UPDATE exploits SET name = $1, command = $2, path = $3, tag = $4, timeout = $5, enabled = $6 WHERE id = $7", exploit.Name, exploit.Command, exploit.Path, exploit.Tag, exploit.Timeout, exploit.Enabled, exploit.Id)
	return err
}

func (db *Database) DeleteExploit(id int64) error {
	_, err := db.DB.Exec("DELETE FROM exploits WHERE id = $1", id)
	return err
}

func (db *Database) DeleteAllExploits() error {
	_, err := db.DB.Exec("DELETE FROM exploits")
	return err
}

func (db *Database) SetEnabledExploit(exploit model.Exploit) error {
	_, err := db.DB.Exec("UPDATE exploits SET enabled = $1 WHERE id = $2", exploit.Enabled, exploit.Id)
	return err
}
